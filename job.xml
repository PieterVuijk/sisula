<workflow name="%System%_%Source%_Workflow">
    <variable name="database" value="%Database%"/>
    <variable name="path" value="\\localhost\sisula\data"/>
    <variable name="pattern" value="%Source%.*\.txt"/>
    <job name="%System%_%Source%_Staging">
        This is the staging job.
        <variable name="tableName" value="MyTable"/>
        <jobstep name="Create raw table" database_name="%database%" subsystem="TSQL" on_success_action="3">
          EXEC %System%_%Source%_CreateRawTable
        </jobstep>
        <jobstep name="Bulk insert" database_name="%database%" subsystem="PowerShell" on_success_action="3">
          $files = Get-ChildItem FileSystem::%path% | Where-Object {$_.Name -match "%pattern%"}
          ForEach ($file in $files) {
            $returnValue = Invoke-Sqlcmd "EXEC SMHI_Weather_BulkInsert '%path%\$file'" -Database "%database%"
            If($returnValue) { Write-Host "$returnValue" }
          }
        </jobstep>
        <jobstep name="Add key to raw table" database_name="%database%" subsystem="TSQL" on_success_action="3">
          EXEC %System%_%Source%_AddKeyToRawTable
        </jobstep>
        <jobstep name="Create typed tables" database_name="%database%" subsystem="TSQL">
          EXEC %System%_%Source%_CreateTypedTables
        </jobstep>
    </job>
    <job name="%System%_%Source%_Loading">
        <jobstep id="1" name="Load DW tables" subsystem="TSQL">
        </jobstep>
    </job>
</workflow>
