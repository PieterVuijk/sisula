<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="utf-8" />
   <title>sisula Loading Report</title>

   <HTA:APPLICATION
        APPLICATIONNAME="sisula Loading Report"
        ICON="LoadingReport.ico"
        SCROLL="yes"
 	      SINGLEINSTANCE="yes"
 	      WINDOWSTATE="maximize"
        ID="sisula"
    />

    <!-- web fonts (in case we need a nice one for text later)
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
    -->

    <style type="text/css">
      body {
  		    font:               10pt "Open Sans", "Helvetica Neue", sans-serif;
  		    color:              #000000;
  		    background:         #f9f8f7;
  		}
      select, input {
  			width: 				        10em;
  		}
  		label {
  			position: 			      relative;
  			top: 				          -3px;
  			padding-right: 		    10px;
  			padding-left: 		    10px;
  		}
    </style>

    <script
    type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization',
           'version':'1','packages':['timeline']}]}"></script>

    <script type="text/javascript" language="JavaScript">

    function fetchDatabases() {
      var statement = "select [name] from master.sys.databases;"
      var result = query(statement);
      populateSelect('databases', result, 'name', 'name');
    }
    function query(statement) {
      var connection = new ActiveXObject("ADODB.Connection");
      var connectionString =
          "Provider=SQLOLEDB.1;" +
          "Integrated Security=SSPI;" +
          "Persist Security Info=True;" +
          "Initial Catalog=" + (databases.value || 'master') + ";" +
          "Data Source=" + server.value + ";" +
          "Use Procedure for Prepare=1;" +
          "Auto Translate=True;" +
          "Packet Size=4096;" +
          "Use Encryption for Data=False;" +
          "Tag with column collation when possible=False"
      connection.Open(connectionString);
      // alert(connectionString);
      return connection.Execute(statement);
    }
    function populateSelect(select, result, optionField, valueField) {
      var selectElement = document.getElementById(select);
      while (selectElement.firstChild) {
          selectElement.removeChild(selectElement.firstChild);
      }
      while(!result.EOF) {
        var option = document.createElement('option');
        option.value = result.Fields(valueField);
        option.innerHTML = result.Fields(optionField);
        selectElement.appendChild(option);
        result.MoveNext();
      }
    }

    function drawChart() {

      var statement = "\
      select \
      	jb.JB_ID, \
      	jb.JB_EST_EST_ExecutionStatus, \
      	jb.JB_NAM_Job_Name, \
      	datepart(year, v.date_JB_STA_Job_Start) as year_JB_STA_Job_Start, \
      	datepart(month, v.date_JB_STA_Job_Start) as month_JB_STA_Job_Start, \
      	datepart(day, v.date_JB_STA_Job_Start) as day_JB_STA_Job_Start, \
      	datepart(hour, v.time_JB_STA_Job_Start) as hour_JB_STA_Job_Start, \
      	datepart(minute, v.time_JB_STA_Job_Start) as minute_JB_STA_Job_Start, \
      	datepart(second, v.time_JB_STA_Job_Start) as second_JB_STA_Job_Start, \
        datepart(millisecond, v.time_JB_STA_Job_Start) as millisecond_JB_STA_Job_Start, \
      	datepart(hour, v.time_JB_END_Job_End) as hour_JB_END_Job_End, \
      	datepart(minute, v.time_JB_END_Job_End) as minute_JB_END_Job_End, \
      	datepart(second, v.time_JB_END_Job_End) as second_JB_END_Job_End, \
        datepart(millisecond, v.time_JB_END_Job_End) as millisecond_JB_END_Job_End, \
      	jb.JB_AID_Job_AgentJobId \
      from \
      	metadata.lJB_Job jb \
      outer apply ( \
          values ( \
      		case when jb.JB_EST_EST_ExecutionStatus = 'Running' then getdate() else jb.JB_END_Job_End end \
      	) \
      ) t (trans_JB_END_Job_End) \
      outer apply ( \
      	values ( \
      		cast(jb.JB_STA_Job_Start as date), \
      		cast(t.trans_JB_END_Job_End as date), \
      		cast(jb.JB_STA_Job_Start as time(3)), \
      		cast(t.trans_JB_END_Job_End as time(3)) \
      	) \
      ) v (date_JB_STA_Job_Start, date_JB_END_Job_End, time_JB_STA_Job_Start, time_JB_END_Job_End) \
      order by \
        JB_ID desc; \
      ";
      var result = query(statement);

      var year_JB_STA_Job_Start,
          month_JB_STA_Job_Start,
          day_JB_STA_Job_Start,
          hour_JB_STA_Job_Start,
          minute_JB_STA_Job_Start,
          second_JB_STA_Job_Start,
          millisecond_JB_STA_Job_Start,
          hour_JB_END_Job_End,
          minute_JB_END_Job_End,
          second_JB_END_Job_End,
          millisecond_JB_END_Job_End,
          JB_NAM_Job_Name,
          JB_EST_EST_ExecutionStatus,
          JB_ID;

      var rows = [];

      while(!result.EOF) {
        year_JB_STA_Job_Start = result.Fields('year_JB_STA_Job_Start');
        month_JB_STA_Job_Start = ('00' + result.Fields('month_JB_STA_Job_Start')).slice(-2);
        day_JB_STA_Job_Start = ('00' + result.Fields('day_JB_STA_Job_Start')).slice(-2);
        hour_JB_STA_Job_Start = result.Fields('hour_JB_STA_Job_Start');
        minute_JB_STA_Job_Start = result.Fields('minute_JB_STA_Job_Start');
        second_JB_STA_Job_Start = result.Fields('second_JB_STA_Job_Start');
        millisecond_JB_STA_Job_Start = result.Fields('millisecond_JB_STA_Job_Start');
        hour_JB_END_Job_End = result.Fields('hour_JB_END_Job_End');
        minute_JB_END_Job_End = result.Fields('minute_JB_END_Job_End');
        second_JB_END_Job_End = result.Fields('second_JB_END_Job_End');
        millisecond_JB_END_Job_End = result.Fields('millisecond_JB_END_Job_End');
        JB_NAM_Job_Name = result.Fields('JB_NAM_Job_Name');
        JB_EST_EST_ExecutionStatus = '' + result.Fields('JB_EST_EST_ExecutionStatus');
        JB_ID = result.Fields('JB_ID');

        rows.push({
            c:[
              {v: year_JB_STA_Job_Start + '-' + month_JB_STA_Job_Start + '-' + day_JB_STA_Job_Start},
              {v: JB_ID + ' ' + JB_NAM_Job_Name},
              {v: new Date(
                    0, 0, 0,
                    hour_JB_STA_Job_Start,
                    minute_JB_STA_Job_Start,
                    second_JB_STA_Job_Start,
                    millisecond_JB_STA_Job_Start
                  )
              },
              {v: new Date(
                    0, 0, 0,
                    hour_JB_END_Job_End,
                    minute_JB_END_Job_End,
                    second_JB_END_Job_End,
                    millisecond_JB_END_Job_End
                  )
              },
              {v: JB_EST_EST_ExecutionStatus}
            ]
        });

        result.MoveNext();
      }

      var container = document.getElementById('chart');
      var chart = new google.visualization.Timeline(container);

      var dataTable = new google.visualization.DataTable(
        {
          cols: [
            {id: 'Day',    label: 'Day',    type: 'string'},
            {id: 'Name',   label: 'Name',   type: 'string'},
            {id: 'Start',  label: 'Start',  type: 'datetime'},
            {id: 'End',    label: 'End',    type: 'datetime'},
            {id: 'Result', label: 'Result', type: 'string'}
          ],
          rows: rows
        }
      );

      var rowHeight = 41;
      var chartHeight = (dataTable.getNumberOfRows() + 1) * rowHeight;

      var colors = [];
      var colorMap = {
          // should contain a map of category -> color for every category
          Success: '#99d594',
          Failure: '#fc8d59',
          Running: '#ffffbf'
      }
      for (var i = 0; i < dataTable.getNumberOfRows(); i++) {
          colors.push(colorMap[dataTable.getValue(i, 4)]);
      }

      var options = {
          timeline: { groupByRowLabel: true, colorByRowLabel: false },
          avoidOverlappingGridLines: false,
          colors: colors,
          height: chartHeight,
          width: '100%'
      };

      // use a DataView to hide the category column from the Timeline
      var view = new google.visualization.DataView(dataTable);
      view.setColumns([0, 1, 2, 3]);

      chart.draw(view, options);

      document.getElementById('refresh').disabled = false;
    }
    </script>
    </head>
<body>
  <label for="server">Server:</label><input id="server" type="text" value="" />
	<input id="connect" type="button" value="Connect" onclick="fetchDatabases()" />
	<label for="database">Database:</label><select id="databases" onchange="drawChart()"></select>
  <input id="refresh" type="button" value="Refresh" onclick="drawChart()" disabled="true" />
  <p>
    <div id="chart"></div>
  </p>
</body>
</html>
