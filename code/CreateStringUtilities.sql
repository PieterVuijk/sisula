IF Object_Id('dbo.Splitter', 'FT') IS NOT NULL
DROP FUNCTION [dbo].[Splitter];
GO

IF Object_Id('dbo.Try_Execute', 'FS') IS NOT NULL
DROP FUNCTION [dbo].[Try_Execute];
GO

IF EXISTS (
	SELECT
		*
	FROM
		sys.assemblies
	WHERE
		name = 'StringUtilities'
)
DROP ASSEMBLY StringUtilities;

CREATE ASSEMBLY StringUtilities 
AUTHORIZATION dbo 
-- you can use the DLL instead if you substitute for your path:
--FROM 'C:\sisula\code\Splitter.dll' 
-- or you can use the binary representation of the compiled code:
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030075A047540000000000000000E00002210B010800000E000000060000000000005E2C0000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000102C00004B00000000400000A802000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000640C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000402C000000000000480000000200050008220000080A000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009A0F00FE16030000016F0600000A0F01FE16030000016F0600000A16280700000A6F0800000A2A0013300300370000000100001102740F0000010A066F0900000A7E0A00000A280B00000A2C0C037E0C00000A81030000012A03066F0900000A730D00000A81030000012A1E02280E00000A2A001B30020045000000020000117E010000046F0F00000A7E020000040F00FE16030000016F0600000A6F1000000A7E020000046F1100000A267E0C00000A0BDE0F0A066F0600000A281200000A0BDE00072A00000001100000000021001334000F14000001927201000070731300000A800100000472310000707E01000004731400000A80020000042A1E02280E00000A2A0000001B30050061000000020000117E030000046F0F00000A7E0400000472330000700F01FE16030000016F0600000A724B0000700F00FE16030000016F0600000A281500000A6F1000000A7E040000046F1100000A267E0C00000A0BDE0F0A066F0600000A281200000A0BDE00072A0000000110000000003D001350000F14000001927201000070731300000A800300000472310000707E03000004731400000A80040000042A1E02280E00000A2A00000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000C0020000237E00002C0300000C03000023537472696E67730000000038060000500000002355530088060000100000002347554944000000980600007003000023426C6F620000000000000002000001571502000900000000FA013300160000010000001400000004000000040000000900000007000000150000000700000002000000010000000300000000000A00010000000000060045003E0006005F004C000A008C0077000A00C500AF000A00E600AF000A001801FD000600670148010600B10191010600D10191010A00EF01FD000E002C020D020E0032020D020E0038020D020E0045020D020E0060020D020E0066020D02060078023E000A00A90296020A00BB0296020600F1023E00000000000100000000000100010001001000170000000500010001000100100020000000050001000400010010002C0000000500030007003100D30026003100F1002A003100D30026003100F1002A00502000000000960096000A0001007820000000009600A10013000300BB20000000008618A9001B000500C42000000000960096001F0005004D21000000008618A9001B0006002821000000009118FB0235030600582100000000960096002E000600FD21000000008618A9001B000800D821000000009118FB023503080000000100F900000002002A01000001003201020002004201000001007401000001007E010000020088013100A9001B003900A9001B004100A9004A004900A9001B005100A9001B0009000402B30159003202B70161005502C00181006E02B30189007F02C50189008502C80119009102CE011900A900D2010900A9001B009100B6021B009900C502D2019900D50224031900E50228032100A900D2012900A900390389000203400320002B004F0024000B0037002E00230051032E001B00480380002B00DC0184000B003700E0002B00DC01D7012E0304800000000000000000000000000000000017000000020000000000000000000000010035000000000002000000000000000000000001006B000000000002000000000000000000000001003E000000000000000000003C4D6F64756C653E0053706C69747465722E646C6C0053706C6974746572005472795F45786563757465005472795F43617374006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E730049456E756D657261626C650053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E6700496E69744D6574686F640046696C6C526F77002E63746F720053797374656D2E446174612E53716C436C69656E740053716C436F6E6E656374696F6E006461746162617365436F6E6E656374696F6E0053716C436F6D6D616E6400636F6D6D616E6400726F77004D6963726F736F66742E53716C5365727665722E5365727665720053716C4661636574417474726962757465007061747465726E0066726F6D456E756D65726174696F6E006D617463680053797374656D2E52756E74696D652E496E7465726F705365727669636573004F75744174747269627574650073746174656D656E74006461746156616C75650064617461547970650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053716C46756E6374696F6E41747472696275746500546F537472696E670053797374656D2E546578742E526567756C617245787072657373696F6E73005265676578004D617463680052656765784F7074696F6E730047726F7570436F6C6C656374696F6E006765745F47726F7570730047726F75700043617074757265006765745F56616C756500537472696E6700456D707479006F705F457175616C697479004E756C6C0053797374656D2E446174612E436F6D6D6F6E004462436F6E6E656374696F6E004F70656E004462436F6D6D616E64007365745F436F6D6D616E645465787400457865637574654E6F6E5175657279006F705F496D706C6963697400457863657074696F6E002E6363746F7200436F6E63617400000000002F63006F006E007400650078007400200063006F006E006E0065006300740069006F006E003D007400720075006500000100176400650063006C00610072006500200040007400200000033D0000002F682E83F815D446B12CFACB5FA0949F0008B77A5C561934E0890800021209110D110D070002011C10110D03200001060001110D110D0306121103061215080002110D110D110D12010001005408074D617853697A65FFFFFFFF042001010881620100050054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E1146696C6C526F774D6574686F644E616D650746696C6C526F770320000E08000312310E0E1135042000123902060E050002020E0E0306110D042001010E040701123D81460100040054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730100000054020F497344657465726D696E6973746963015402094973507265636973650103200008050001110D0E0607021251110D03000001062002010E12110700040E0E0E0E0E0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301382C000000000000000000004E2C0000002000000000000000000000000000000000000000000000402C00000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000D00010049006E007400650072006E0061006C004E0061006D0065000000530070006C00690074007400650072002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000D0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530070006C00690074007400650072002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000603C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE;
GO

CREATE FUNCTION Splitter(@row AS nvarchar(max), @pattern AS nvarchar(4000))
RETURNS TABLE (
	[match] nvarchar(max)
) AS EXTERNAL NAME StringUtilities.Splitter.InitMethod;
GO

CREATE FUNCTION Try_Execute(@statement AS nvarchar(4000))
RETURNS NVARCHAR(4000) 
AS EXTERNAL NAME StringUtilities.Try_Execute.InitMethod;
GO

sp_configure 'clr enabled', 1
GO
reconfigure with override
GO

/*
with strgen as (
	select
		'Hello World' as s,
		1 as n
	union all 
	select
		s,
		n + 1
	from 
		strgen
	where
		n < 100000
)
select
	*
from 
	strgen
cross apply (
	select 
		[match],
		ROW_NUMBER() OVER (ORDER BY (SELECT 1)) as i
	from
		dbo.Splitter(N'Hello World', N'(.{2}).*(Wo)(rl).*')
) s
pivot (
	max(match) for i in ([2], [3], [4], [5])
) p
option (maxrecursion 0);
*/




