IF Object_Id('dbo.Splitter', 'FT') IS NOT NULL
DROP FUNCTION [dbo].[Splitter];
GO

IF EXISTS (
	SELECT
		*
	FROM
		sys.assemblies
	WHERE
		name = 'StringUtilities'
)
DROP ASSEMBLY StringUtilities;

CREATE ASSEMBLY StringUtilities 
AUTHORIZATION dbo 
-- you can use the DLL instead if you substitute for your path:
-- FROM 'C:\sisula\code\Splitter.dll' 
-- or you can use the binary representation of the compiled code:
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300AE2246540000000000000000E00002210B0108000008000000060000000000005E270000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000042700005700000000400000A802000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000064070000002000000008000000020000000000000000000000000000200000602E72737263000000A80200000040000000040000000A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000E0000000000000000000000000000400000420000000000000000000000000000000040270000000000004800000002000500C02000004406000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007E026F0500000A0F01FE16040000016F0500000A16280600000A6F0700000A2A13300300390000000100001102740D0000010A066F0800000A7E0900000A280A00000A2C0D037E0B00000A730C00000A512A03066F0800000A280D00000A730C00000A512A1E02280E00000A2A00000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000C0010000237E00002C0200002002000023537472696E6773000000004C04000008000000235553005404000010000000234755494400000064040000E001000023426C6F620000000000000002000001471502000900000000FA013300160000010000000F0000000200000003000000040000000E0000000300000001000000010000000300000000000A0001000000000006003000290006004A0037000A00770062000A00800062000600E400C50006001101F10006003101F1000A006A014F010E00A70188010E00AD0188010E00B30188010E00C00188010E00DB0188010E00E10188010600F30129000000000001000000000001000100010010001700000005000100010050200000000096008A000A0001007020000000009600950013000300B5200000000086189D001B00050000000100A30000000200A70000000100AF0002000200BF0029009D001B0031009D001F0039009D001B0041009D001B0009007F0188014900AD018C015100D00195017100E90188017900FA019A01790000029D0121000C02A30119009D00A70121001102AD0109009D001B002000230024002E001300B8012E001B00C101B3010480000000000000000000000000000000001700000002000000000000000000000001002000000000000200000000000000000000000100560000000000020000000000000000000000010029000000000000000000003C4D6F64756C653E0053706C69747465722E646C6C0053706C6974746572006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E730049456E756D657261626C650053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C43686172730053716C537472696E6700496E69744D6574686F640046696C6C526F77002E63746F7200726F77007061747465726E0066726F6D456E756D65726174696F6E006D617463680053797374656D2E52756E74696D652E496E7465726F705365727669636573004F75744174747269627574650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E41747472696275746500546F537472696E670053797374656D2E546578742E526567756C617245787072657373696F6E73005265676578004D617463680052656765784F7074696F6E730047726F7570436F6C6C656374696F6E006765745F47726F7570730047726F75700043617074757265006765745F56616C756500537472696E6700456D707479006F705F457175616C697479004E756C6C006F705F496D706C696369740000000000032000000000009EA9A32879F066458E74D9C500E3A0FC0008B77A5C561934E0890800021209120D1111070002011C10120D03200001042001010881620100050054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D44617461416363657373000000005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E1146696C6C526F774D6574686F644E616D650746696C6C526F770320000E08000312290E0E112D042000123102060E050002020E0E0306111105200101111105000111110E04070112350801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773012C27000000000000000000004E270000002000000000000000000000000000000000000000000000402700000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500204000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000D00010049006E007400650072006E0061006C004E0061006D0065000000530070006C00690074007400650072002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000D0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530070006C00690074007400650072002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000603700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE;
GO

CREATE FUNCTION Splitter(@row AS nvarchar(max), @pattern AS nvarchar(4000))
RETURNS TABLE (
	[match] nvarchar(max)
) AS EXTERNAL NAME StringUtilities.Splitter.InitMethod;
GO

sp_configure 'clr enabled', 1
GO
reconfigure with override
GO

/*
with strgen as (
	select
		'Hello World' as s,
		1 as n
	union all 
	select
		s,
		n + 1
	from 
		strgen
	where
		n < 100000
)
select
	*
from 
	strgen
cross apply (
	select 
		[match],
		ROW_NUMBER() OVER (ORDER BY (SELECT 1)) as i
	from
		dbo.Splitter(N'Hello World', N'(.{2}).*(Wo)(rl).*')
) s
pivot (
	max(match) for i in ([2], [3], [4], [5])
) p
option (maxrecursion 0);
*/




