<source name="%Source%" codepage="ACP" datafiletype="char" fieldterminator="\r\n">
	<description>http://www.slb.mf.stockholm.se</description>
    <part name="TemperatureNew" nulls="">
        SELECT * from %System%_%Source%_Raw WHERE [row] LIKE '[0-9][0-9][0-9][0-9][0-9][0-9],%'
        <term name="date" delimiter="," format="date">
            '20' + [date]
        </term>
        <term name="hour" pattern="\s*([0-9]{2})[0-9]{2}," format="char(2)"/>
        <term name="celsius1" delimiter="," format="decimal(19,10)"/>
        <term name="celsius2" delimiter="," format="decimal(19,10)"/>
        <term name="celsius3" delimiter="," format="decimal(19,10)"/>
        <term name="celsius4" delimiter="," format="decimal(19,10)"/>
    </part>
    <part name="TemperatureNewMetadata">
        <!-- 
            CHAR(183) is 路 (small bullet), which is rarely used so we can use it as our own 
            internal delimiter for the regex matching later. The select below builds a 
            concatenation of a number of rows.
        -->
        SELECT
			*
		FROM (
			SELECT 
				_file,
				MIN(_id) as _id,
				MIN(_timestamp) as _timestamp
			FROM (
                SELECT
                    *
                FROM
                    %System%_%Source%_Raw
                WHERE 
                    [row] LIKE '#%'
		    ) src
			GROUP BY
				_file
		) f
		CROSS APPLY (
			SELECT
				[row] + CHAR(183) AS [text()]
			FROM (
                SELECT
                    *
                FROM
                    %System%_%Source%_Raw
                WHERE 
					[row] LIKE '#%'
		    ) src
			WHERE
				src._file = f._file
			FOR XML PATH('')
		) c ([row])
        <!-- 
            on the format (?=.*?KeyName[^:]*:\s*([^路]*))?
            positive lookahead with an optional number of preceeding characters leading 
            up to the string to match, after which we capture everything leading up to the
            next delimiter, and the whole non-capturing group is optional in case the 
            string is not present at all.
        -->
        <term name="graphType" pattern="(?=.*?Graftyp[^:]*:\s*([^路]*))?" format="varchar(42)"/>
        <term name="weekday" pattern="(?=.*?Veckodag[^:]*:\s*([^路]*))?" format="varchar(42)"/>
    </part>
    <part name="Temperature" nulls="" charskip="4"> 
        SELECT * FROM %System%_%Source%_Raw WHERE [row] LIKE 'TEMP%'
        <term name="date" size="6" format="date">
            CASE LEFT([date],1) WHEN '0' THEN '20' + [date] ELSE '19' + [date] END
        </term>
        <term name="hour" size="4" format="char(2)">
            LEFT([hour], 2)
        </term>
        <term name="celsius" delimiter=" " format="decimal(19,10)">
            REPLACE([celsius], ',', '.')
        </term>
        <calculation name="fahrenheit" format="decimal(19,10)">
            9 / 5 * [celsius] + 32
        </calculation>
        <calculation name="freezing" format="char(1)">
            CASE 
                WHEN [celsius] &gt; 0 THEN 'A' 
                WHEN [celsius] &lt; 0 THEN 'B' 
                WHEN [celsius] = 0 THEN 'Z' 
                ELSE '?' 
            END
        </calculation>
        <key name="measureTime" type="primary key">
            <component of="date"/>
            <component of="hour"/>
        </key>
    </part>
    <part name="Pressure" nulls="" charskip="4">
        SELECT * FROM %System%_%Source%_Raw WHERE [row] LIKE 'PRSR%'
        <term name="date" size="6" format="date">
            CASE LEFT([date],1) WHEN '0' THEN '20' + [date] ELSE '19' + [date] END
        </term>
        <term name="hour" size="4" format="char(2)">
            LEFT([hour], 2)
        </term>
        <term name="pressure" size="10" format="decimal(19,10)">
            REPLACE([pressure], ',', '.')
        </term>
        <key name="measureTime" type="primary key">
            <component of="date"/>
            <component of="hour"/>
        </key>        
    </part>
    <part name="Wind" nulls="" charskip="4">
        SELECT * FROM %System%_%Source%_Raw WHERE [row] LIKE 'WNDS%'
        <term name="date" size="6" format="date">
            CASE LEFT([date],1) WHEN '0' THEN '20' + [date] ELSE '19' + [date] END
        </term>
        <term name="hour" size="4" format="char(2)">
            LEFT([hour], 2)
        </term>
        <term name="direction" size="10" format="decimal(5,2)">
            REPLACE([direction], ',', '.')
        </term>
        <term name="speed" size="10" format="decimal(19,10)">
            REPLACE([speed], ',', '.')
        </term>
        <key name="measureTime" type="primary key">
            <component of="date"/>
            <component of="hour"/>
        </key>
    </part>
</source>
